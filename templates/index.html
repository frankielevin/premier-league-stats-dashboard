<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premier League Stats 2025-26</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <div class="dashboard">
        <!-- Header -->
        <header class="header">
            <div class="club-info">
                <!-- Single Team Dropdown (hidden in compare mode) -->
                <div class="custom-dropdown" id="team-dropdown">
                    <button class="dropdown-trigger" id="dropdown-trigger">
                        <span class="selected-team" id="selected-team-name">West Ham United</span>
                        <svg class="dropdown-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M6 9l6 6 6-6"/>
                        </svg>
                    </button>
                    <div class="dropdown-menu" id="dropdown-menu">
                        <div class="dropdown-search">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"/>
                                <path d="M21 21l-4.35-4.35"/>
                            </svg>
                            <input type="text" id="team-search" placeholder="Search teams..." autocomplete="off">
                        </div>
                        <div class="dropdown-list" id="dropdown-list">
                            {% for key, team in teams.items() %}
                            <div class="dropdown-item {% if key == 'west-ham' %}active{% endif %}" data-value="{{ key }}">
                                {{ team.name }}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <span class="season-badge">2025-26 Premier League</span>
            </div>
            <div class="header-actions">
                <div class="last-updated">
                    <span class="update-label">Last updated</span>
                    <span class="update-time" id="last-updated">--:--</span>
                </div>
                <button id="refresh-btn" class="refresh-btn">
                    <svg class="refresh-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                    </svg>
                    <span>Refresh</span>
                </button>
                <button id="screenshot-btn" class="screenshot-btn" title="Save screenshot">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/>
                        <circle cx="12" cy="13" r="4"/>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="tabs">
            <button class="tab-btn active" data-category="attacking">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M12 6v6l4 2"/>
                </svg>
                Attacking
            </button>
            <button class="tab-btn" data-category="passing">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                </svg>
                Passing
            </button>
            <button class="tab-btn" data-category="defending">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                </svg>
                Defending
            </button>
            <button class="tab-btn" data-category="goalkeeping">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                    <path d="M3 9h18M3 15h18M9 3v18M15 3v18"/>
                </svg>
                Goalkeeping
            </button>
            <button class="tab-btn" data-category="miscellaneous">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
                Miscellaneous
            </button>
            <div class="tab-divider"></div>
            <button class="tab-btn tab-compare" data-category="compare">
                Compare
            </button>
        </nav>

        <!-- Loading State -->
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <p>Fetching latest stats...</p>
        </div>

        <!-- Stats Grid (Single Team View) -->
        <main class="stats-grid" id="stats-container">
            <!-- Stats will be loaded here -->
        </main>

        <!-- Compare View -->
        <main class="compare-view hidden" id="compare-container">
            <!-- Matchup Header -->
            <div class="matchup-header">
                <div class="matchup-team team-left">
                    <div class="compare-dropdown" id="compare-dropdown-1" data-value="arsenal">
                        <button class="compare-dropdown-trigger">
                            <span class="compare-selected-team">Arsenal</span>
                            <svg class="compare-dropdown-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M6 9l6 6 6-6"/>
                            </svg>
                        </button>
                        <div class="compare-dropdown-menu">
                            <div class="compare-dropdown-search">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"/>
                                    <path d="M21 21l-4.35-4.35"/>
                                </svg>
                                <input type="text" placeholder="Search teams..." autocomplete="off">
                            </div>
                            <div class="compare-dropdown-list">
                                {% for key, team in teams.items() %}
                                <div class="compare-dropdown-item {% if key == 'arsenal' %}active{% endif %}" data-value="{{ key }}">
                                    {{ team.name }}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <div class="team-score" id="team1-score">0</div>
                    <div class="team-score-label">Overall Stats Won</div>
                </div>

                <div class="matchup-center">
                    <div class="vs-badge">
                        <span class="vs-text">VS</span>
                    </div>
                    <div class="matchup-category" id="current-category-label"></div>
                </div>

                <div class="matchup-team team-right">
                    <div class="compare-dropdown" id="compare-dropdown-2" data-value="west-ham">
                        <button class="compare-dropdown-trigger">
                            <span class="compare-selected-team">West Ham United</span>
                            <svg class="compare-dropdown-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M6 9l6 6 6-6"/>
                            </svg>
                        </button>
                        <div class="compare-dropdown-menu">
                            <div class="compare-dropdown-search">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"/>
                                    <path d="M21 21l-4.35-4.35"/>
                                </svg>
                                <input type="text" placeholder="Search teams..." autocomplete="off">
                            </div>
                            <div class="compare-dropdown-list">
                                {% for key, team in teams.items() %}
                                <div class="compare-dropdown-item {% if key == 'west-ham' %}active{% endif %}" data-value="{{ key }}">
                                    {{ team.name }}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <div class="team-score" id="team2-score">0</div>
                    <div class="team-score-label">Overall Stats Won</div>
                </div>
            </div>

            <!-- Category Picker -->
            <div class="compare-picker">
                <p class="compare-picker-label">Select a category to view comparison</p>
                <div class="compare-tabs">
                    <button class="compare-tab-btn" data-compare-category="attacking">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 6v6l4 2"/>
                        </svg>
                        Attacking
                    </button>
                    <button class="compare-tab-btn" data-compare-category="passing">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                        </svg>
                        Passing
                    </button>
                    <button class="compare-tab-btn" data-compare-category="defending">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                        </svg>
                        Defending
                    </button>
                    <button class="compare-tab-btn" data-compare-category="goalkeeping">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                            <path d="M3 9h18M3 15h18M9 3v18M15 3v18"/>
                        </svg>
                        Goalkeeping
                    </button>
                    <button class="compare-tab-btn" data-compare-category="miscellaneous">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                        </svg>
                        Miscellaneous
                    </button>
                </div>
            </div>

            <!-- Hidden — kept for JS compatibility -->
            <div class="compare-stats" id="compare-stats" style="display:none"></div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <span>Data from StatMuse</span>
            <span class="divider">•</span>
            <span>Premier League 2025-26</span>
        </footer>
    </div>

    <!-- Category Stats Modal -->
    <div class="stat-modal-overlay" id="stat-modal-overlay">
        <div class="stat-modal" id="stat-modal">
            <button class="modal-close-btn" id="modal-close-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>

            <div class="modal-matchup-header">
                <div class="modal-team-block modal-left">
                    <div class="modal-team-name" id="modal-team1-name"></div>
                    <div class="modal-wins-display leading" id="modal-team1-wins">
                        <span class="modal-wins-num" id="modal-wins-num1">0</span>
                        <span class="modal-wins-label">stats won</span>
                    </div>
                </div>
                <div class="modal-center-block">
                    <div class="modal-vs-badge">VS</div>
                    <div class="modal-category-pill" id="modal-category-pill">ATTACKING</div>
                </div>
                <div class="modal-team-block modal-right">
                    <div class="modal-team-name" id="modal-team2-name"></div>
                    <div class="modal-wins-display" id="modal-team2-wins">
                        <span class="modal-wins-num" id="modal-wins-num2">0</span>
                        <span class="modal-wins-label">stats won</span>
                    </div>
                </div>
            </div>

            <div class="modal-stats-grid" id="modal-stats-grid">
                <!-- Stats populated by JS -->
            </div>
        </div>
        <!-- Screenshot button sits outside the modal, in the gap below -->
        <button class="modal-screenshot-btn" id="modal-screenshot-btn" title="Save screenshot">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/>
                <circle cx="12" cy="13" r="4"/>
            </svg>
            <span>Save Screenshot</span>
        </button>
    </div>

    <script>
        const statsContainer = document.getElementById('stats-container');
        const compareContainer = document.getElementById('compare-container');
        const compareStats = document.getElementById('compare-stats');
        const loading = document.getElementById('loading');
        const refreshBtn = document.getElementById('refresh-btn');
        const lastUpdated = document.getElementById('last-updated');
        const tabBtns = document.querySelectorAll('.tab-btn');
        const compareTabBtns = document.querySelectorAll('.compare-tab-btn');

        // Custom dropdown elements
        const dropdown = document.getElementById('team-dropdown');
        const dropdownTrigger = document.getElementById('dropdown-trigger');
        const dropdownMenu = document.getElementById('dropdown-menu');
        const dropdownList = document.getElementById('dropdown-list');
        const selectedTeamName = document.getElementById('selected-team-name');
        const teamSearch = document.getElementById('team-search');
        const dropdownItems = document.querySelectorAll('.dropdown-item');

        // Compare custom dropdowns
        const compareDropdown1 = document.getElementById('compare-dropdown-1');
        const compareDropdown2 = document.getElementById('compare-dropdown-2');

        let allStats = {};
        let compareStats1 = {};
        let compareStats2 = {};
        let currentCategory = 'attacking';
        let currentCompareCategory = 'attacking';
        let currentTeam = 'west-ham';
        let isCompareMode = false;

        // Stats where StatMuse ranks by highest raw value first (rank 1 = most = worst for these stats)
        // Only these need the colour mapping inverted. Other lower-is-better stats (GC, YC, etc.)
        // are already ranked by StatMuse with rank 1 = best (fewest), so no inversion needed.
        const INVERTED_STATS = ['xGA', 'ERR-SH', 'ERR-G', 'PKC', 'OG', 'AER-L', 'DUEL-L', 'POSS-L'];

        // Stats where LOWER raw value is better — used by compare mode to decide the winner
        const LOWER_IS_BETTER = ['OFF', 'xGA', 'TKL-LM', 'ERR-SH', 'ERR-G', 'PKC', 'OG', 'GC', 'GC/M', 'YC', 'RC', 'FOUL', 'AER-L', 'DUEL-L', 'POSS-L'];

        // Custom dropdown functionality
        dropdownTrigger.addEventListener('click', (e) => {
            e.stopPropagation();
            dropdown.classList.toggle('open');
            if (dropdown.classList.contains('open')) {
                teamSearch.focus();
                teamSearch.value = '';
                filterTeams('');
            }
        });

        document.addEventListener('click', (e) => {
            if (!dropdown.contains(e.target)) {
                dropdown.classList.remove('open');
            }
        });

        teamSearch.addEventListener('input', (e) => {
            filterTeams(e.target.value.toLowerCase());
        });

        function filterTeams(query) {
            dropdownItems.forEach(item => {
                const teamName = item.textContent.toLowerCase();
                item.style.display = teamName.includes(query) ? 'block' : 'none';
            });
        }

        dropdownItems.forEach(item => {
            item.addEventListener('click', () => {
                const teamKey = item.dataset.value;
                const teamName = item.textContent.trim();
                dropdownItems.forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                selectedTeamName.textContent = teamName;
                currentTeam = teamKey;
                dropdown.classList.remove('open');
                fetchAllStats();
            });
        });

        teamSearch.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') dropdown.classList.remove('open');
        });

        // Tab switching
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                tabBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                const category = btn.dataset.category;

                if (category === 'compare') {
                    isCompareMode = true;
                    statsContainer.classList.add('hidden');
                    compareContainer.classList.remove('hidden');
                    dropdown.classList.add('hidden');
                    fetchCompareStats();
                } else {
                    isCompareMode = false;
                    currentCategory = category;
                    statsContainer.classList.remove('hidden');
                    compareContainer.classList.add('hidden');
                    dropdown.classList.remove('hidden');
                    displayStats(currentCategory);
                }
            });
        });

        // Compare category tabs — open modal only
        compareTabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                compareTabBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentCompareCategory = btn.dataset.compareCategory;
                openCategoryModal(currentCompareCategory);
            });
        });

        // Compare custom dropdown functionality
        function initCompareDropdown(dropdown) {
            const trigger = dropdown.querySelector('.compare-dropdown-trigger');
            const menu = dropdown.querySelector('.compare-dropdown-menu');
            const searchInput = dropdown.querySelector('.compare-dropdown-search input');
            const items = dropdown.querySelectorAll('.compare-dropdown-item');
            const selectedText = dropdown.querySelector('.compare-selected-team');

            trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                // Close other dropdown and reset z-index
                document.querySelectorAll('.compare-dropdown.open').forEach(d => {
                    if (d !== dropdown) {
                        d.classList.remove('open');
                        d.closest('.matchup-team').classList.remove('dropdown-active');
                    }
                });
                dropdown.classList.toggle('open');
                dropdown.closest('.matchup-team').classList.toggle('dropdown-active', dropdown.classList.contains('open'));
                if (dropdown.classList.contains('open')) {
                    searchInput.focus();
                    searchInput.value = '';
                    items.forEach(item => item.style.display = 'block');
                }
            });

            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                items.forEach(item => {
                    const teamName = item.textContent.toLowerCase();
                    item.style.display = teamName.includes(query) ? 'block' : 'none';
                });
            });

            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') dropdown.classList.remove('open');
            });

            items.forEach(item => {
                item.addEventListener('click', () => {
                    const teamKey = item.dataset.value;
                    const teamName = item.textContent.trim();
                    items.forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    selectedText.textContent = teamName;
                    dropdown.dataset.value = teamKey;
                    dropdown.classList.remove('open');
                    dropdown.closest('.matchup-team').classList.remove('dropdown-active');
                    fetchCompareStats();
                });
            });
        }

        initCompareDropdown(compareDropdown1);
        initCompareDropdown(compareDropdown2);

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.compare-dropdown')) {
                document.querySelectorAll('.compare-dropdown.open').forEach(d => {
                    d.classList.remove('open');
                    d.closest('.matchup-team').classList.remove('dropdown-active');
                });
            }
        });

        // Refresh button
        refreshBtn.addEventListener('click', () => {
            if (isCompareMode) {
                fetchCompareStats();
            } else {
                fetchAllStats();
            }
        });

        function showLoading() {
            loading.style.display = 'flex';
            statsContainer.style.opacity = '0';
            compareContainer.style.opacity = '0';
            refreshBtn.style.display = 'none';
        }

        function hideLoading() {
            loading.style.display = 'none';
            statsContainer.style.opacity = '1';
            compareContainer.style.opacity = '1';
            refreshBtn.style.display = '';
        }

        function isInvertedStat(abbrev) {
            return INVERTED_STATS.includes(abbrev);
        }

        function isLowerBetter(abbrev) {
            return LOWER_IS_BETTER.includes(abbrev);
        }

        function getRankNumber(rank) {
            if (!rank || rank === '-') return null;
            return parseInt(rank.replace(/\D/g, ''));
        }

        function getRankClass(rank, inverted = false) {
            const num = getRankNumber(rank);
            if (num === null) return 'rank-none';
            if (inverted) {
                if (num <= 5) return 'rank-poor';
                if (num <= 10) return 'rank-average';
                if (num <= 15) return 'rank-good';
                return 'rank-excellent';
            } else {
                if (num <= 5) return 'rank-excellent';
                if (num <= 10) return 'rank-good';
                if (num <= 15) return 'rank-average';
                return 'rank-poor';
            }
        }

        function getRankLabel(rank, inverted = false) {
            const num = getRankNumber(rank);
            if (num === null) return '';
            if (inverted) {
                if (num <= 5) return 'Poor';
                if (num <= 10) return 'Below Avg';
                if (num <= 15) return 'Good';
                return 'Excellent';
            } else {
                if (num <= 5) return 'Excellent';
                if (num <= 10) return 'Good';
                if (num <= 15) return 'Average';
                return 'Below Avg';
            }
        }

        function getRankPercentage(rank, inverted = false) {
            const num = getRankNumber(rank);
            if (num === null) return 0;
            if (inverted) {
                return Math.max(5, (num - 1) * 5 + 5);
            } else {
                return Math.max(5, 100 - ((num - 1) * 5));
            }
        }

        function parseStatValue(value) {
            if (!value || value === '-') return null;
            const cleaned = value.replace(/,/g, '').replace('%', '');
            return parseFloat(cleaned);
        }

        function displayStats(category) {
            const data = allStats[category];
            if (!data || !data.success || data.stats.length === 0) {
                statsContainer.innerHTML = `
                    <div class="error-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 8v4M12 16h.01"/>
                        </svg>
                        <p>Unable to load ${category} stats</p>
                    </div>
                `;
                return;
            }

            const statsToShow = data.stats.filter(s => s.abbrev !== 'M');
            let html = '';

            statsToShow.forEach((stat, index) => {
                const inverted = isInvertedStat(stat.abbrev);
                const rankClass = getRankClass(stat.rank, inverted);
                const rankPct = getRankPercentage(stat.rank, inverted);
                const rankLabel = getRankLabel(stat.rank, inverted);

                html += `
                    <div class="stat-card ${rankClass}" style="animation-delay: ${index * 0.03}s">
                        <div class="stat-header">
                            <span class="stat-abbrev">${stat.abbrev}</span>
                            ${stat.rank !== '-' ? `<span class="rank-badge">${stat.rank}</span>` : ''}
                        </div>
                        <div class="stat-value">${stat.club}</div>
                        <div class="stat-name">${stat.name}</div>
                        ${stat.rank !== '-' ? `
                            <div class="rank-bar-container">
                                <div class="rank-bar" style="width: ${rankPct}%"></div>
                                <div class="rank-positions">
                                    <span class="pos-marker" style="left: ${rankPct}%">
                                        <span class="pos-dot"></span>
                                    </span>
                                </div>
                            </div>
                            <div class="rank-label">${rankLabel}</div>
                        ` : '<div class="rank-label no-rank">No ranking</div>'}
                    </div>
                `;
            });

            statsContainer.innerHTML = html;
            requestAnimationFrame(() => {
                statsContainer.querySelectorAll('.stat-card').forEach(card => {
                    card.classList.add('animate-in');
                });
            });
        }

        function displayComparison() {
            const data1 = compareStats1[currentCompareCategory];
            const data2 = compareStats2[currentCompareCategory];
            const categoryLabel = document.getElementById('current-category-label');
            const team1ScoreEl = document.getElementById('team1-score');
            const team2ScoreEl = document.getElementById('team2-score');

            // Update category label
            categoryLabel.textContent = currentCompareCategory.toUpperCase();

            if (!data1?.success || !data2?.success) {
                compareStats.innerHTML = `
                    <div class="error-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 8v4M12 16h.01"/>
                        </svg>
                        <p>Unable to load comparison data</p>
                    </div>
                `;
                return;
            }

            const stats1 = data1.stats.filter(s => s.abbrev !== 'M');
            const stats2 = data2.stats.filter(s => s.abbrev !== 'M');

            let html = '';
            let team1Wins = 0;
            let team2Wins = 0;

            stats1.forEach((stat1, index) => {
                const stat2 = stats2.find(s => s.abbrev === stat1.abbrev) || { club: '-', rank: '-' };
                const val1 = parseStatValue(stat1.club);
                const val2 = parseStatValue(stat2.club);
                const lowerBetter = isLowerBetter(stat1.abbrev);

                let winner = 'draw';
                if (val1 !== null && val2 !== null && val1 !== val2) {
                    if (lowerBetter) {
                        winner = val1 < val2 ? 'team1' : 'team2';
                    } else {
                        winner = val1 > val2 ? 'team1' : 'team2';
                    }
                }

                // Count wins
                if (winner === 'team1') team1Wins++;
                if (winner === 'team2') team2Wins++;

                // Calculate bar percentages
                let bar1Pct = 50, bar2Pct = 50;
                if (val1 !== null && val2 !== null && (val1 + val2) > 0) {
                    const total = Math.abs(val1) + Math.abs(val2);
                    bar1Pct = (Math.abs(val1) / total) * 100;
                    bar2Pct = (Math.abs(val2) / total) * 100;
                }

                const team1Class = winner === 'team1' ? 'winner' : (winner === 'team2' ? 'loser' : 'draw');
                const team2Class = winner === 'team2' ? 'winner' : (winner === 'team1' ? 'loser' : 'draw');

                // Trophy icon for winner
                const trophyIcon = `<svg class="winner-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C13.1 2 14 2.9 14 4V5H19C19.55 5 20 5.45 20 6V9C20 11.21 18.21 13 16 13H15.83C15.42 14.17 14.31 15 13 15V17H14C15.1 17 16 17.9 16 19V21H8V19C8 17.9 8.9 17 10 17H11V15C9.69 15 8.58 14.17 8.17 13H8C5.79 13 4 11.21 4 9V6C4 5.45 4.45 5 5 5H10V4C10 2.9 10.9 2 12 2M6 7V9C6 10.1 6.9 11 8 11V7H6M16 11C17.1 11 18 10.1 18 9V7H16V11Z"/></svg>`;

                html += `
                    <div class="compare-row ${team1Class === 'winner' || team2Class === 'winner' ? 'has-winner' : ''}" style="--delay: ${index * 0.05}s">
                        <div class="stat-cell team1 ${team1Class}">
                            <div class="stat-value-wrap">
                                ${winner === 'team1' ? trophyIcon : ''}
                                <span class="stat-main-value">${stat1.club}</span>
                            </div>
                            <span class="stat-rank">${stat1.rank !== '-' ? stat1.rank : ''}</span>
                        </div>

                        <div class="stat-center">
                            <div class="stat-label">
                                <span class="stat-abbrev">${stat1.abbrev}</span>
                                <span class="stat-name">${stat1.name}</span>
                            </div>
                            <div class="comparison-bar">
                                <div class="bar-left ${team1Class}" style="--width: ${bar1Pct}%"></div>
                                <div class="bar-right ${team2Class}" style="--width: ${bar2Pct}%"></div>
                            </div>
                        </div>

                        <div class="stat-cell team2 ${team2Class}">
                            <div class="stat-value-wrap">
                                <span class="stat-main-value">${stat2.club}</span>
                                ${winner === 'team2' ? trophyIcon : ''}
                            </div>
                            <span class="stat-rank">${stat2.rank !== '-' ? stat2.rank : ''}</span>
                        </div>
                    </div>
                `;
            });

            // Update score counters with animation
            animateScore(team1ScoreEl, team1Wins);
            animateScore(team2ScoreEl, team2Wins);

            // Add winner glow to leading team
            team1ScoreEl.parentElement.classList.toggle('leading', team1Wins > team2Wins);
            team2ScoreEl.parentElement.classList.toggle('leading', team2Wins > team1Wins);

            compareStats.innerHTML = html;

            // Trigger animations
            requestAnimationFrame(() => {
                compareStats.querySelectorAll('.compare-row').forEach((row, i) => {
                    setTimeout(() => {
                        row.classList.add('animate-in');
                    }, i * 50);
                });
            });
        }

        function animateScore(element, targetValue) {
            const currentValue = parseInt(element.textContent) || 0;
            const duration = 500;
            const startTime = performance.now();

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easeProgress = 1 - Math.pow(1 - progress, 3);
                const value = Math.round(currentValue + (targetValue - currentValue) * easeProgress);
                element.textContent = value;

                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }

            requestAnimationFrame(update);
        }

        async function fetchAllStats() {
            showLoading();
            refreshBtn.disabled = true;
            refreshBtn.classList.add('loading');

            try {
                const response = await fetch(`/api/stats?team=${currentTeam}`);
                const data = await response.json();
                allStats = {
                    attacking: data.attacking,
                    passing: data.passing,
                    defending: data.defending,
                    goalkeeping: data.goalkeeping,
                    miscellaneous: data.miscellaneous
                };
                displayStats(currentCategory);
                updateLastUpdated();
            } catch (error) {
                statsContainer.innerHTML = `
                    <div class="error-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 8v4M12 16h.01"/>
                        </svg>
                        <p>Connection error. Please try again.</p>
                    </div>
                `;
            } finally {
                hideLoading();
                refreshBtn.disabled = false;
                refreshBtn.classList.remove('loading');
            }
        }

        function calculateTotalWins() {
            const categories = ['attacking', 'passing', 'defending', 'goalkeeping', 'miscellaneous'];
            let team1Total = 0;
            let team2Total = 0;

            categories.forEach(category => {
                const data1 = compareStats1[category];
                const data2 = compareStats2[category];
                if (!data1?.success || !data2?.success) return;

                const stats1 = data1.stats.filter(s => s.abbrev !== 'M');
                const stats2 = data2.stats.filter(s => s.abbrev !== 'M');

                stats1.forEach(stat1 => {
                    const stat2 = stats2.find(s => s.abbrev === stat1.abbrev) || { club: '-' };
                    const val1 = parseStatValue(stat1.club);
                    const val2 = parseStatValue(stat2.club);
                    const lowerBetter = isLowerBetter(stat1.abbrev);

                    if (val1 !== null && val2 !== null && val1 !== val2) {
                        if (lowerBetter ? val1 < val2 : val1 > val2) {
                            team1Total++;
                        } else {
                            team2Total++;
                        }
                    }
                });
            });

            return { team1Total, team2Total };
        }

        function updateHeaderScores() {
            const { team1Total, team2Total } = calculateTotalWins();
            const team1ScoreEl = document.getElementById('team1-score');
            const team2ScoreEl = document.getElementById('team2-score');
            animateScore(team1ScoreEl, team1Total);
            animateScore(team2ScoreEl, team2Total);
            team1ScoreEl.parentElement.classList.toggle('leading', team1Total > team2Total);
            team2ScoreEl.parentElement.classList.toggle('leading', team2Total > team1Total);
        }

        async function fetchCompareStats() {
            showLoading();
            refreshBtn.disabled = true;
            refreshBtn.classList.add('loading');

            const team1 = compareDropdown1.dataset.value;
            const team2 = compareDropdown2.dataset.value;

            try {
                const [res1, res2] = await Promise.all([
                    fetch(`/api/stats?team=${team1}`),
                    fetch(`/api/stats?team=${team2}`)
                ]);

                const data1 = await res1.json();
                const data2 = await res2.json();

                compareStats1 = {
                    attacking: data1.attacking,
                    passing: data1.passing,
                    defending: data1.defending,
                    goalkeeping: data1.goalkeeping,
                    miscellaneous: data1.miscellaneous
                };

                compareStats2 = {
                    attacking: data2.attacking,
                    passing: data2.passing,
                    defending: data2.defending,
                    goalkeeping: data2.goalkeeping,
                    miscellaneous: data2.miscellaneous
                };

                updateHeaderScores();
                updateLastUpdated();
            } catch (error) {
                compareStats.innerHTML = `
                    <div class="error-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 8v4M12 16h.01"/>
                        </svg>
                        <p>Connection error. Please try again.</p>
                    </div>
                `;
            } finally {
                hideLoading();
                refreshBtn.disabled = false;
                refreshBtn.classList.remove('loading');
            }
        }

        function updateLastUpdated() {
            const now = new Date();
            lastUpdated.textContent = now.toLocaleTimeString('en-GB', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ============================================
        //  Category Stats Modal
        // ============================================

        const statModalOverlay = document.getElementById('stat-modal-overlay');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalTeam1Name = document.getElementById('modal-team1-name');
        const modalTeam2Name = document.getElementById('modal-team2-name');
        const modalWinsNum1 = document.getElementById('modal-wins-num1');
        const modalWinsNum2 = document.getElementById('modal-wins-num2');
        const modalTeam1Wins = document.getElementById('modal-team1-wins');
        const modalTeam2Wins = document.getElementById('modal-team2-wins');
        const modalCategoryPill = document.getElementById('modal-category-pill');
        const modalStatsGrid = document.getElementById('modal-stats-grid');

        function openCategoryModal(category) {
            const data1 = compareStats1[category];
            const data2 = compareStats2[category];
            if (!data1?.success || !data2?.success) return;

            // Team names
            const t1Name = compareDropdown1.querySelector('.compare-selected-team').textContent.trim();
            const t2Name = compareDropdown2.querySelector('.compare-selected-team').textContent.trim();
            modalTeam1Name.textContent = t1Name;
            modalTeam2Name.textContent = t2Name;
            modalCategoryPill.textContent = category.toUpperCase();

            // Update the VS header label now that a category is chosen
            document.getElementById('current-category-label').textContent = category.toUpperCase();

            // Build content
            const { html, team1Wins, team2Wins } = buildModalContent(category, data1, data2);
            modalStatsGrid.innerHTML = html;

            // Update modal win counts
            modalWinsNum1.textContent = team1Wins;
            modalWinsNum2.textContent = team2Wins;
            modalTeam1Wins.classList.toggle('leading', team1Wins > team2Wins);
            modalTeam2Wins.classList.toggle('leading', team2Wins > team1Wins);
            modalTeam1Wins.classList.toggle('trailing', team1Wins < team2Wins);
            modalTeam2Wins.classList.toggle('trailing', team2Wins < team1Wins);


            // Open modal
            statModalOverlay.classList.add('open');
            document.body.style.overflow = 'hidden';

            // Stagger animate cards
            requestAnimationFrame(() => {
                modalStatsGrid.querySelectorAll('.modal-stat-item').forEach((el, i) => {
                    setTimeout(() => el.classList.add('animate-in'), i * 30);
                });
            });
        }

        function buildModalContent(category, data1, data2) {
            const stats1 = data1.stats.filter(s => s.abbrev !== 'M');
            const stats2 = data2.stats.filter(s => s.abbrev !== 'M');
            let html = '';
            let team1Wins = 0;
            let team2Wins = 0;

            stats1.forEach((stat1) => {
                const stat2 = stats2.find(s => s.abbrev === stat1.abbrev) || { club: '-', rank: '-' };
                const val1 = parseStatValue(stat1.club);
                const val2 = parseStatValue(stat2.club);
                const lowerBetter = isLowerBetter(stat1.abbrev);

                let winner = 'draw';
                if (val1 !== null && val2 !== null && val1 !== val2) {
                    winner = lowerBetter ? (val1 < val2 ? 'team1' : 'team2') : (val1 > val2 ? 'team1' : 'team2');
                }

                if (winner === 'team1') team1Wins++;
                if (winner === 'team2') team2Wins++;

                let bar1Pct = 50, bar2Pct = 50;
                if (val1 !== null && val2 !== null && (Math.abs(val1) + Math.abs(val2)) > 0) {
                    const total = Math.abs(val1) + Math.abs(val2);
                    bar1Pct = (Math.abs(val1) / total) * 100;
                    bar2Pct = (Math.abs(val2) / total) * 100;
                }

                const c1 = winner === 'team1' ? 'winner' : (winner === 'team2' ? 'loser' : 'draw');
                const c2 = winner === 'team2' ? 'winner' : (winner === 'team1' ? 'loser' : 'draw');

                html += `
                    <div class="modal-stat-item">
                        <div class="modal-val-cell left ${c1}">
                            <div class="modal-val-inner">
                                <span class="modal-main-val">${stat1.club}</span>
                                ${stat1.rank !== '-' ? `<span class="modal-rank-pill">${stat1.rank}</span>` : ''}
                            </div>
                        </div>
                        <div class="modal-stat-info">
                            <span class="modal-abbrev">${stat1.abbrev}</span>
                            <span class="modal-stat-name-text">${stat1.name}</span>
                            <div class="modal-bar">
                                <div class="modal-bar-left ${c1}" style="width: ${bar1Pct}%"></div>
                                <div class="modal-bar-right ${c2}" style="width: ${bar2Pct}%"></div>
                            </div>
                        </div>
                        <div class="modal-val-cell right ${c2}">
                            <div class="modal-val-inner">
                                <span class="modal-main-val">${stat2.club}</span>
                                ${stat2.rank !== '-' ? `<span class="modal-rank-pill">${stat2.rank}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            return { html, team1Wins, team2Wins };
        }

        function closeModal() {
            statModalOverlay.classList.remove('open');
            document.body.style.overflow = '';
        }

        modalCloseBtn.addEventListener('click', closeModal);
        statModalOverlay.addEventListener('click', (e) => {
            if (e.target === statModalOverlay) closeModal();
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && statModalOverlay.classList.contains('open')) closeModal();
        });

        // ============================================
        // Screenshot — exports 1280×720 PNG
        // ============================================
        async function captureElement(element, filename) {
            const allScreenshotBtns = document.querySelectorAll('.screenshot-btn, .modal-screenshot-btn');
            allScreenshotBtns.forEach(b => b.style.visibility = 'hidden');

            try {
                const canvas = await html2canvas(element, {
                    backgroundColor: '#0F0F13',
                    useCORS: true,
                    allowTaint: true,
                    logging: false,
                    scale: window.devicePixelRatio || 1
                });

                const link = document.createElement('a');
                link.download = filename;
                link.href = canvas.toDataURL('image/png');
                link.click();
            } finally {
                allScreenshotBtns.forEach(b => b.style.visibility = '');
            }
        }

        // Single-team view: capture only the stats grid (all cards, no header/tabs)
        document.getElementById('screenshot-btn').addEventListener('click', async () => {
            const teamName = document.getElementById('selected-team-name').textContent.trim().replace(/\s+/g, '-');
            const grid = document.querySelector('.stats-grid');
            const dashboard = document.querySelector('.dashboard');

            const prev = {
                gridOverflow: grid.style.overflow,
                gridHeight: grid.style.height,
                gridMaxHeight: grid.style.maxHeight,
                dashOverflow: dashboard.style.overflow
            };
            grid.style.overflow = 'visible';
            grid.style.height = 'auto';
            grid.style.maxHeight = 'none';
            dashboard.style.overflow = 'visible';

            try {
                await captureElement(grid, `${teamName}-stats.png`);
            } finally {
                grid.style.overflow = prev.gridOverflow;
                grid.style.height = prev.gridHeight;
                grid.style.maxHeight = prev.gridMaxHeight;
                dashboard.style.overflow = prev.dashOverflow;
            }
        });

        // Compare modal: capture only the modal panel itself
        document.getElementById('modal-screenshot-btn').addEventListener('click', () => {
            const t1 = document.getElementById('modal-team1-name').textContent.trim().replace(/\s+/g, '-');
            const t2 = document.getElementById('modal-team2-name').textContent.trim().replace(/\s+/g, '-');
            const cat = document.getElementById('modal-category-pill').textContent.trim().toLowerCase();
            captureElement(document.getElementById('stat-modal'), `${t1}-vs-${t2}-${cat}.png`);
        });

        // Initial load
        fetchAllStats();
    </script>
</body>
</html>
